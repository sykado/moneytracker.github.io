<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>50-Day Random Savings Challenge</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            border-radius: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        input, button {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .draw-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
        }

        .person-selector {
            margin-bottom: 25px;
        }

        .person-selector h3 {
            margin-bottom: 15px;
            color: #555;
            font-size: 1.1em;
        }

        .person-frames {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .person-frame {
            width: 80px;
            height: 100px;
            border: 4px solid #8B4513;
            border-radius: 8px;
            background: linear-gradient(135deg, #f4f4f4, #e8e8e8);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .person-frame:nth-child(1) {
            transform: rotate(-3deg);
        }

        .person-frame:nth-child(2) {
            transform: rotate(2deg);
        }

        .person-frame:nth-child(3) {
            transform: rotate(-1deg);
        }

        .person-frame:nth-child(4) {
            transform: rotate(3deg);
        }

        .person-frame:nth-child(5) {
            transform: rotate(-2deg);
        }

        .person-frame:hover {
            transform: scale(1.1) rotate(0deg);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            z-index: 5;
        }

        .person-frame.selected {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #ffe8e8, #ffcccc);
            transform: scale(1.05) rotate(0deg);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }

        .person-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .person-frame .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            font-size: 12px;
            text-align: center;
            padding: 5px;
        }

        .person-frame .placeholder .icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .person-frame .name {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .person-frame:hover .name,
        .person-frame.selected .name {
            opacity: 1;
        }

        .selected-person {
            margin-bottom: 15px;
            font-weight: 600;
            color: #667eea;
        }

        .person-names-section {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .person-names-section h3 {
            margin-bottom: 15px;
            color: #2d3436;
            font-size: 1.2em;
        }

        .person-names-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .person-name-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .person-name-input label {
            font-size: 12px;
            color: #666;
        }

        .person-name-input input {
            padding: 8px 12px;
            font-size: 14px;
        }

        .date-selector {
            margin-bottom: 15px;
        }

        .date-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .date-selector input[type="date"] {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            min-width: 200px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(116, 185, 255, 0.3);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 20px;
        }

        .pagination button.active {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .draw-button {
            font-size: 18px;
            padding: 15px 30px;
            border-radius: 50px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            min-width: 200px;
        }

        .number-card {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ffffff, #f1f3f4);
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding: 5px;
        }

        .number-card .number {
            font-size: 18px;
            line-height: 1;
        }

        .number-card .date {
            font-size: 10px;
            font-weight: normal;
            opacity: 0.7;
            margin-top: 2px;
            text-align: center;
            line-height: 1.1;
        }

        .number-card:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .number-card.used {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
            border-color: #e84393;
        }

        .number-card.used::after {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 12px;
            color: white;
        }

        .number-card.used:hover::before {
            content: '✏️ Click to edit';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .number-card.used:hover::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid rgba(0, 0, 0, 0.8);
            z-index: 11;
        }

        .number-card.available:hover::before {
            content: '✅ Click to mark as saved';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .number-card.available:hover::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid rgba(0, 0, 0, 0.8);
            z-index: 11;
        }

        .number-card.just-drawn {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
            animation: pulse 1s ease-in-out;
            border-color: #e17055;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .completion-message {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .last-drawn {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .import-export-section {
            background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .import-export-section h3 {
            margin-bottom: 15px;
            color: #2d3436;
            font-size: 1.2em;
        }

        .import-export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .import-export-buttons button {
            min-width: 140px;
            font-size: 14px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .notification.error {
            background: linear-gradient(135deg, #ff7675, #d63031);
        }

        .notification.warning {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }

        .data-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 80%;
            max-height: 80%;
            overflow: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff7675;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
        }

        .data-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            overflow: auto;
            max-height: 400px;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .modal-buttons {
            margin-top: 20px;
            text-align: center;
        }

        .modal-buttons button {
            margin: 0 5px;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .edit-modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .edit-modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .edit-modal .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .edit-modal .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .edit-modal .form-group input {
            width: 100%;
        }

        .edit-modal .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .edit-modal .button-group button {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            min-width: 100px;
        }

        .edit-modal .save-btn {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border: none;
        }

        .edit-modal .cancel-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border: none;
        }

        .edit-modal .delete-btn {
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: white;
            border: none;
        }

        .manual-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .manual-modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .manual-modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .manual-modal .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .manual-modal .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .manual-modal .form-group input {
            width: 100%;
        }

        .manual-modal .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .manual-modal .button-group button {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            min-width: 100px;
        }

        .manual-modal .save-btn {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border: none;
        }

        .manual-modal .cancel-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border: none;
        }

        .help-text {
            background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            color: #2d3436;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .numbers-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 8px;
            }
            
            .number-card {
                font-size: 14px;
            }

            .import-export-buttons {
                flex-direction: column;
                align-items: center;
            }

            .pagination {
                flex-direction: column;
                align-items: center;
            }

            .stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .edit-modal-content, .manual-modal-content {
                padding: 20px;
            }

            .edit-modal .button-group, .manual-modal .button-group {
                flex-direction: column;
            }

            .button-group {
                gap: 4px;
            }

            .person-frames {
                gap: 10px;
            }

            .person-frame {
                width: 60px;
                height: 75px;
            }

            .person-names-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>💰 50-Day Random Savings Challenge</h1>
        
        <div class="help-text">
            💡 <strong>Tips:</strong> Click on any checked number (pink) to edit it • Click on any white number to manually mark it as saved • Customize person names below and select who draws the number!
        </div>

        <div class="person-names-section">
            <h3>👥 Customize Person Names</h3>
            <div class="person-names-grid">
                <div class="person-name-input">
                    <label>Person 1:</label>
                    <input type="text" id="personName0" placeholder="Enter name..." onchange="updatePersonName(0, this.value)">
                </div>
                <div class="person-name-input">
                    <label>Person 2:</label>
                    <input type="text" id="personName1" placeholder="Enter name..." onchange="updatePersonName(1, this.value)">
                </div>
                <div class="person-name-input">
                    <label>Person 3:</label>
                    <input type="text" id="personName2" placeholder="Enter name..." onchange="updatePersonName(2, this.value)">
                </div>
                <div class="person-name-input">
                    <label>Person 4:</label>
                    <input type="text" id="personName3" placeholder="Enter name..." onchange="updatePersonName(3, this.value)">
                </div>
                <div class="person-name-input">
                    <label>Person 5:</label>
                    <input type="text" id="personName4" placeholder="Enter name..." onchange="updatePersonName(4, this.value)">
                </div>
            </div>
        </div>

        <div class="import-export-section">
            <h3>💾 Data Management</h3>
            <div class="import-export-buttons">
                <button onclick="exportData()" style="background: linear-gradient(135deg, #00b894, #00a085);">
                    📥 Export Data as JSON
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button onclick="document.getElementById('importFile').click()" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe);">
                    📤 Import JSON Data
                </button>
                <button onclick="viewDataPreview()" style="background: linear-gradient(135deg, #fdcb6e, #e17055);">
                    👁️ Preview Data
                </button>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="savingsGoal">Savings Goal (€)</label>
                <input type="number" id="savingsGoal" placeholder="e.g., 1000" min="0">
            </div>
            <div class="control-group">
                <label for="startingBalance">Starting Balance (€)</label>
                <input type="number" id="startingBalance" placeholder="e.g., 100" min="0">
            </div>
            <div class="button-group">
                <button onclick="updateSettings()">💾 Update Settings</button>
                <button onclick="resetChallenge()" style="background: linear-gradient(135deg, #ff7675, #d63031);">🔄 Reset Challenge</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalSaved">€0</div>
                <div class="stat-label">Total Saved</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="remainingDays">50</div>
                <div class="stat-label">Days Remaining</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="progressPercent">0%</div>
                <div class="stat-label">Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="goalProgress">0%</div>
                <div class="stat-label">Goal Achievement</div>
            </div>
        </div>

        <div id="lastDrawn" class="last-drawn" style="display: none;">
            Last drawn: €<span id="lastDrawnAmount">0</span> on <span id="lastDrawnDate"></span> by <span id="lastDrawnPerson">Someone</span>
        </div>

        <div class="draw-section">
            <div class="person-selector">
                <h3>👥 Who's drawing today?</h3>
                <div class="person-frames" id="personFrames">
                    <!-- Frames will be generated by JavaScript -->
                </div>
                <div class="selected-person" id="selectedPersonText">Click on a person to select who draws the number!</div>
            </div>

            <div class="date-selector">
                <label for="drawDate">Select Date for Draw:</label>
                <input type="date" id="drawDate" />
            </div>
            <button id="drawButton" class="draw-button" onclick="drawNumber()">
                🎲 Draw Random Number
            </button>
        </div>

        <div id="completionMessage" class="completion-message" style="display: none;">
            🎉 Congratulations! You've completed your 50-day challenge!
            <br>Starting a new challenge cycle...
        </div>

        <div class="pagination">
            <button id="prevCycle" onclick="switchCycle(-1)">← Previous Cycle</button>
            <span id="cycleInfo">Cycle 1</span>
            <button id="nextCycle" onclick="switchCycle(1)">Next Cycle →</button>
        </div>

        <div class="numbers-grid" id="numbersGrid"></div>

        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>

        <!-- Data Preview Modal -->
        <div id="dataModal" class="data-modal">
            <div class="modal-content">
                <button onclick="closeDataModal()" class="modal-close">×</button>
                <h3 style="margin-bottom: 20px; color: #2d3436;">📊 Data Preview</h3>
                <pre id="dataPreview" class="data-preview"></pre>
                <div class="modal-buttons">
                    <button onclick="copyDataToClipboard()" style="background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; border: none;">📋 Copy to Clipboard</button>
                    <button onclick="exportData()" style="background: linear-gradient(135deg, #00b894, #00a085); color: white; border: none;">💾 Download JSON</button>
                </div>
            </div>
        </div>

        <!-- Edit Number Modal -->
        <div id="editModal" class="edit-modal">
            <div class="edit-modal-content">
                <h3>✏️ Edit Number Entry</h3>
                <div class="form-group">
                    <label for="editDate">Date:</label>
                    <input type="date" id="editDate">
                </div>
                <div class="form-group">
                    <label>Amount: €<span id="editAmount">0</span></label>
                </div>
                <div class="button-group">
                    <button class="save-btn" onclick="saveEdit()">💾 Save Changes</button>
                    <button class="delete-btn" onclick="deleteEntry()">🗑️ Remove Entry</button>
                    <button class="cancel-btn" onclick="closeEditModal()">❌ Cancel</button>
                </div>
            </div>
        </div>

        <!-- Manual Add Modal -->
        <div id="manualModal" class="manual-modal">
            <div class="manual-modal-content">
                <h3>✅ Mark Number as Saved</h3>
                <div class="form-group">
                    <label for="manualDate">Date when you saved this amount:</label>
                    <input type="date" id="manualDate">
                </div>
                <div class="form-group">
                    <label>Amount: €<span id="manualAmount">0</span></label>
                </div>
                <div class="button-group">
                    <button class="save-btn" onclick="saveManualEntry()">✅ Mark as Saved</button>
                    <button class="cancel-btn" onclick="closeManualModal()">❌ Cancel</button>
                </div>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notification" class="notification"></div>
    </div>

    <script>
        let gameData = {
            cycles: [
                {
                    numbers: Array.from({length: 50}, (_, i) => ({
                        value: i + 1,
                        used: false,
                        dayUsed: null,
                        dateUsed: null,
                        drawnBy: null
                    })),
                    totalSaved: 0,
                    startingBalance: 0,
                    savingsGoal: 1275, // Default goal (sum of 1-50)
                    dailyProgress: [],
                    lastDrawn: null,
                    lastDrawnBy: null,
                    completed: false
                }
            ],
            currentCycle: 0,
            people: [
                { name: "Person 1", image: null },
                { name: "Person 2", image: null },
                { name: "Person 3", image: null },
                { name: "Person 4", image: null },
                { name: "Person 5", image: null }
            ]
        };

        let chart = null;
        let editingNumber = null;
        let manualNumber = null;
        let selectedPerson = null;

        // Update person name
        function updatePersonName(personIndex, newName) {
            if (newName.trim() === '') {
                gameData.people[personIndex].name = `Person ${personIndex + 1}`;
            } else {
                gameData.people[personIndex].name = newName.trim();
            }
            
            saveData();
            updatePersonFrames();
            updateSelectedPersonText();
        }

        // Update person frames display
        function updatePersonFrames() {
            const framesContainer = document.getElementById('personFrames');
            framesContainer.innerHTML = '';
            
            gameData.people.forEach((person, index) => {
                const frame = document.createElement('div');
                frame.className = 'person-frame';
                frame.setAttribute('data-person', index);
                frame.onclick = () => selectPerson(index);
                
                if (selectedPerson === index) {
                    frame.classList.add('selected');
                }
                
                frame.innerHTML = `
                    <div class="placeholder">
                        <div class="icon">👤</div>
                        <div>${person.name}</div>
                    </div>
                    <div class="name">${person.name}</div>
                `;
                
                framesContainer.appendChild(frame);
            });
        }

        // Update selected person text
        function updateSelectedPersonText() {
            const textElement = document.getElementById('selectedPersonText');
            if (selectedPerson !== null) {
                const personName = gameData.people[selectedPerson].name;
                textElement.textContent = `${personName} will draw the number!`;
            } else {
                textElement.textContent = 'Click on a person to select who draws the number!';
            }
        }

        // Person selection functionality
        function selectPerson(personIndex) {
            selectedPerson = personIndex;
            updatePersonFrames();
            updateSelectedPersonText();
        }

        // Export data as JSON file
        function exportData() {
            try {
                const dataToExport = {
                    ...gameData,
                    exportDate: new Date().toISOString(),
                    version: "1.0"
                };
                
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `savings-challenge-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Data exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Failed to export data!', 'error');
            }
        }

        // Import data from JSON file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/json') {
                showNotification('Please select a valid JSON file!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.cycles || !Array.isArray(importedData.cycles)) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Validate each cycle
                    for (let cycle of importedData.cycles) {
                        if (!cycle.numbers || !Array.isArray(cycle.numbers) || cycle.numbers.length !== 50) {
                            throw new Error('Invalid cycle data');
                        }
                    }
                    
                    if (confirm(`This will replace all your current data with the imported data. The file contains ${importedData.cycles.length} cycle(s). Are you sure you want to continue?`)) {
                        gameData = importedData;
                        
                        // Ensure currentCycle is valid
                        if (gameData.currentCycle >= gameData.cycles.length) {
                            gameData.currentCycle = gameData.cycles.length - 1;
                        }
                        
                        // Ensure people array exists
                        if (!gameData.people) {
                            gameData.people = [
                                { name: "Person 1", image: null },
                                { name: "Person 2", image: null },
                                { name: "Person 3", image: null },
                                { name: "Person 4", image: null },
                                { name: "Person 5", image: null }
                            ];
                        }
                        
                        saveData();
                        updateDisplay();
                        updateChart();
                        updatePersonNameInputs();
                        showNotification('Data imported successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('Failed to import data! Please check the file format.', 'error');
                }
            };
            
            reader.readAsText(file);
            // Reset file input
            event.target.value = '';
        }

        // Update person name inputs
        function updatePersonNameInputs() {
            gameData.people.forEach((person, index) => {
                const input = document.getElementById(`personName${index}`);
                if (input) {
                    input.value = person.name === `Person ${index + 1}` ? '' : person.name;
                }
            });
        }

        // Show data preview modal
        function viewDataPreview() {
            const dataToShow = {
                ...gameData,
                exportDate: new Date().toISOString(),
                version: "1.0"
            };
            
            document.getElementById('dataPreview').textContent = JSON.stringify(dataToShow, null, 2);
            document.getElementById('dataModal').style.display = 'flex';
        }

        // Close data preview modal
        function closeDataModal() {
            document.getElementById('dataModal').style.display = 'none';
        }

        // Copy data to clipboard
        function copyDataToClipboard() {
            const dataText = document.getElementById('dataPreview').textContent;
            navigator.clipboard.writeText(dataText).then(() => {
                showNotification('Data copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy to clipboard!', 'error');
            });
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Manual number entry functionality
        function manualMarkNumber(numberValue) {
            const cycle = getCurrentCycle();
            const number = cycle.numbers.find(n => n.value === numberValue);
            
            if (!number || number.used) return;
            
            manualNumber = number;
            document.getElementById('manualAmount').textContent = number.value;
            document.getElementById('manualDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('manualModal').style.display = 'flex';
        }

        function closeManualModal() {
            document.getElementById('manualModal').style.display = 'none';
            manualNumber = null;
        }

        function saveManualEntry() {
            if (!manualNumber) return;
            
            const selectedDate = document.getElementById('manualDate').value;
            if (!selectedDate) {
                showNotification('Please select a date!', 'error');
                return;
            }
            
            const cycle = getCurrentCycle();
            
            // Check if date is already used
            const dateAlreadyUsed = cycle.numbers.some(n => n.used && n.dateUsed === selectedDate);
            if (dateAlreadyUsed) {
                if (!confirm('A number has already been saved for this date. Do you want to continue anyway?')) {
                    return;
                }
            }
            
            // Mark as used
            manualNumber.used = true;
            manualNumber.dayUsed = cycle.numbers.filter(n => n.used).length;
            manualNumber.dateUsed = selectedDate;
            manualNumber.drawnBy = selectedPerson !== null ? selectedPerson : null;
            
            // Update totals
            cycle.totalSaved += manualNumber.value;
            cycle.lastDrawn = manualNumber.value;
            cycle.lastDrawnDate = selectedDate;
            cycle.lastDrawnBy = selectedPerson !== null ? selectedPerson : null;
            
            // Add to daily progress
            cycle.dailyProgress.push({
                day: manualNumber.dayUsed,
                amount: manualNumber.value,
                cumulative: cycle.totalSaved,
                date: selectedDate,
                drawnBy: selectedPerson !== null ? selectedPerson : null
            });
            
            // Sort daily progress by date
            cycle.dailyProgress.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Recalculate cumulative amounts
            let cumulative = 0;
            cycle.dailyProgress.forEach(progress => {
                cumulative += progress.amount;
                progress.cumulative = cumulative;
            });
            
            // Check if cycle completed
            const availableCount = cycle.numbers.filter(n => !n.used).length;
            if (availableCount === 0) {
                cycle.completed = true;
                // Create new cycle
                gameData.cycles.push({
                    numbers: Array.from({length: 50}, (_, i) => ({
                        value: i + 1,
                        used: false,
                        dayUsed: null,
                        dateUsed: null,
                        drawnBy: null
                    })),
                    totalSaved: 0,
                    startingBalance: cycle.startingBalance + cycle.totalSaved,
                    savingsGoal: cycle.savingsGoal,
                    dailyProgress: [],
                    lastDrawn: null,
                    lastDrawnDate: null,
                    lastDrawnBy: null,
                    completed: false
                });
                
                setTimeout(() => {
                    document.getElementById('completionMessage').style.display = 'block';
                    setTimeout(() => {
                        gameData.currentCycle = gameData.cycles.length - 1;
                        document.getElementById('completionMessage').style.display = 'none';
                        updateDisplay();
                        updateChart();
                    }, 3000);
                }, 500);
            }
            
            saveData();
            updateDisplay();
            updateChart();
            closeManualModal();
            showNotification(`Manually marked €${manualNumber.value} as saved!`, 'success');
        }

        // Edit number functionality
        function editNumber(numberValue) {
            const cycle = getCurrentCycle();
            const number = cycle.numbers.find(n => n.value === numberValue);
            
            if (!number || !number.used) return;
            
            editingNumber = number;
            document.getElementById('editAmount').textContent = number.value;
            document.getElementById('editDate').value = number.dateUsed || '';
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingNumber = null;
        }

        function saveEdit() {
            if (!editingNumber) return;
            
            const newDate = document.getElementById('editDate').value;
            if (!newDate) {
                showNotification('Please select a date!', 'error');
                return;
            }
            
            const cycle = getCurrentCycle();
            
            // Check if the new date conflicts with another entry (excluding current one)
            const dateConflict = cycle.numbers.some(n => 
                n.used && n.dateUsed === newDate && n.value !== editingNumber.value
            );
            
            if (dateConflict) {
                if (!confirm('Another number is already saved for this date. Do you want to continue anyway?')) {
                    return;
                }
            }
            
            // Update the number's date
            editingNumber.dateUsed = newDate;
            
            // Update daily progress
            const progressIndex = cycle.dailyProgress.findIndex(p => p.amount === editingNumber.value);
            if (progressIndex !== -1) {
                cycle.dailyProgress[progressIndex].date = newDate;
                // Re-sort daily progress by date
                cycle.dailyProgress.sort((a, b) => new Date(a.date) - new Date(b.date));
            }
            
            saveData();
            updateDisplay();
            updateChart();
            closeEditModal();
            showNotification('Entry updated successfully!', 'success');
        }

        function deleteEntry() {
            if (!editingNumber) return;
            
            if (!confirm(`Are you sure you want to remove €${editingNumber.value} from your savings? This will also update your total.`)) {
                return;
            }
            
            const cycle = getCurrentCycle();
            
            // Mark number as unused
            editingNumber.used = false;
            editingNumber.dayUsed = null;
            editingNumber.dateUsed = null;
            editingNumber.drawnBy = null;
            
            // Update total saved
            cycle.totalSaved -= editingNumber.value;
            
            // Remove from daily progress
            const progressIndex = cycle.dailyProgress.findIndex(p => p.amount === editingNumber.value);
            if (progressIndex !== -1) {
                cycle.dailyProgress.splice(progressIndex, 1);
                
                // Recalculate cumulative amounts for remaining entries
                let cumulative = 0;
                cycle.dailyProgress.forEach(progress => {
                    cumulative += progress.amount;
                    progress.cumulative = cumulative;
                });
            }
            
            // Update last drawn if this was the last drawn number
            if (cycle.lastDrawn === editingNumber.value) {
                if (cycle.dailyProgress.length > 0) {
                    const lastProgress = cycle.dailyProgress[cycle.dailyProgress.length - 1];
                    cycle.lastDrawn = lastProgress.amount;
                    cycle.lastDrawnDate = lastProgress.date;
                    cycle.lastDrawnBy = lastProgress.drawnBy;
                } else {
                    cycle.lastDrawn = null;
                    cycle.lastDrawnDate = null;
                    cycle.lastDrawnBy = null;
                }
            }
            
            saveData();
            updateDisplay();
            updateChart();
            closeEditModal();
            showNotification('Entry removed successfully!', 'warning');
        }

        // Load data from storage on page load
        function loadData() {
            const saved = JSON.parse(localStorage.getItem('savingsChallenge') || 'null');
            if (saved) {
                gameData = saved;
                
                // Ensure people array exists for backward compatibility
                if (!gameData.people) {
                    gameData.people = [
                        { name: "Person 1", image: null },
                        { name: "Person 2", image: null },
                        { name: "Person 3", image: null },
                        { name: "Person 4", image: null },
                        { name: "Person 5", image: null }
                    ];
                }
            }
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('drawDate').value = today;
            
            updateDisplay();
            createChart();
            updatePersonNameInputs();
        }

        // Save data to storage
        function saveData() {
            localStorage.setItem('savingsChallenge', JSON.stringify(gameData));
        }

        // Get current cycle data
        function getCurrentCycle() {
            return gameData.cycles[gameData.currentCycle];
        }

        // Update settings
        function updateSettings() {
            const goal = parseFloat(document.getElementById('savingsGoal').value) || getCurrentCycle().savingsGoal;
            const starting = parseFloat(document.getElementById('startingBalance').value) || getCurrentCycle().startingBalance;
            
            getCurrentCycle().savingsGoal = goal;
            getCurrentCycle().startingBalance = starting;
            
            saveData();
            updateDisplay();
            updateChart();
            showNotification('Settings updated successfully!', 'success');
        }

        // Draw random number
        function drawNumber() {
            if (selectedPerson === null) {
                showNotification('Please select a person to draw the number!', 'error');
                return;
            }
            
            const cycle = getCurrentCycle();
            const availableNumbers = cycle.numbers.filter(n => !n.used);
            const selectedDate = document.getElementById('drawDate').value;
            
            if (availableNumbers.length === 0) return;
            
            if (!selectedDate) {
                showNotification('Please select a date for this draw!', 'error');
                return;
            }
            
            // Check if date is already used
            const dateAlreadyUsed = cycle.numbers.some(n => n.used && n.dateUsed === selectedDate);
            if (dateAlreadyUsed) {
                if (!confirm('A number has already been drawn for this date. Do you want to draw another number for the same date?')) {
                    return;
                }
            }
            
            const randomIndex = Math.floor(Math.random() * availableNumbers.length);
            const drawnNumber = availableNumbers[randomIndex];
            
            // Mark as used
            drawnNumber.used = true;
            drawnNumber.dayUsed = 51 - availableNumbers.length;
            drawnNumber.dateUsed = selectedDate;
            drawnNumber.drawnBy = selectedPerson;
            
            // Update totals
            cycle.totalSaved += drawnNumber.value;
            cycle.lastDrawn = drawnNumber.value;
            cycle.lastDrawnDate = selectedDate;
            cycle.lastDrawnBy = selectedPerson;
            
            // Add to daily progress
            cycle.dailyProgress.push({
                day: drawnNumber.dayUsed,
                amount: drawnNumber.value,
                cumulative: cycle.totalSaved,
                date: selectedDate,
                drawnBy: selectedPerson
            });
            
            // Sort daily progress by date
            cycle.dailyProgress.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Check if cycle completed
            if (availableNumbers.length === 1) {
                cycle.completed = true;
                // Create new cycle
                gameData.cycles.push({
                    numbers: Array.from({length: 50}, (_, i) => ({
                        value: i + 1,
                        used: false,
                        dayUsed: null,
                        dateUsed: null,
                        drawnBy: null
                    })),
                    totalSaved: 0,
                    startingBalance: cycle.startingBalance + cycle.totalSaved,
                    savingsGoal: cycle.savingsGoal,
                    dailyProgress: [],
                    lastDrawn: null,
                    lastDrawnDate: null,
                    lastDrawnBy: null,
                    completed: false
                });
                
                setTimeout(() => {
                    document.getElementById('completionMessage').style.display = 'block';
                    setTimeout(() => {
                        gameData.currentCycle = gameData.cycles.length - 1;
                        document.getElementById('completionMessage').style.display = 'none';
                        updateDisplay();
                        updateChart();
                    }, 3000);
                }, 500);
            }
            
            saveData();
            updateDisplay();
            updateChart();
            
            const personName = gameData.people[selectedPerson].name;
            showNotification(`${personName} drew €${drawnNumber.value}! Keep saving!`, 'success');
        }

        // Switch between cycles
        function switchCycle(direction) {
            const newCycle = gameData.currentCycle + direction;
            if (newCycle >= 0 && newCycle < gameData.cycles.length) {
                gameData.currentCycle = newCycle;
                updateDisplay();
                updateChart();
            }
        }

        // Reset current challenge
        function resetChallenge() {
            if (confirm('Are you sure you want to reset the current challenge? This cannot be undone.')) {
                const cycle = getCurrentCycle();
                cycle.numbers.forEach(n => {
                    n.used = false;
                    n.dayUsed = null;
                    n.dateUsed = null;
                    n.drawnBy = null;
                });
                cycle.totalSaved = 0;
                cycle.dailyProgress = [];
                cycle.lastDrawn = null;
                cycle.lastDrawnDate = null;
                cycle.lastDrawnBy = null;
                cycle.completed = false;
                
                saveData();
                updateDisplay();
                updateChart();
                showNotification('Challenge reset successfully!', 'success');
            }
        }

        // Update display
        function updateDisplay() {
            const cycle = getCurrentCycle();
            
            // Update form inputs
            document.getElementById('savingsGoal').value = cycle.savingsGoal;
            document.getElementById('startingBalance').value = cycle.startingBalance;
            
            // Update stats
            const totalWithStarting = cycle.startingBalance + cycle.totalSaved;
            document.getElementById('totalSaved').textContent = `€${totalWithStarting}`;
            
            const usedCount = cycle.numbers.filter(n => n.used).length;
            document.getElementById('remainingDays').textContent = 50 - usedCount;
            document.getElementById('progressPercent').textContent = `${Math.round((usedCount / 50) * 100)}%`;
            document.getElementById('goalProgress').textContent = `${Math.round((totalWithStarting / cycle.savingsGoal) * 100)}%`;
            
            // Update last drawn
            if (cycle.lastDrawn) {
                document.getElementById('lastDrawnAmount').textContent = cycle.lastDrawn;
                document.getElementById('lastDrawnDate').textContent = formatDate(cycle.lastDrawnDate);
                const personName = cycle.lastDrawnBy !== null ? gameData.people[cycle.lastDrawnBy].name : 'Someone';
                document.getElementById('lastDrawnPerson').textContent = personName;
                document.getElementById('lastDrawn').style.display = 'block';
            } else {
                document.getElementById('lastDrawn').style.display = 'none';
            }
            
            // Update draw button
            const drawButton = document.getElementById('drawButton');
            const availableCount = cycle.numbers.filter(n => !n.used).length;
            drawButton.disabled = availableCount === 0;
            drawButton.textContent = availableCount === 0 ? '🎉 Challenge Complete!' : '🎲 Draw Random Number';
            
            // Update pagination
            document.getElementById('cycleInfo').textContent = `Cycle ${gameData.currentCycle + 1} of ${gameData.cycles.length}`;
            document.getElementById('prevCycle').disabled = gameData.currentCycle === 0;
            document.getElementById('nextCycle').disabled = gameData.currentCycle === gameData.cycles.length - 1;
            
            // Update person frames and numbers grid
            updatePersonFrames();
            updateNumbersGrid();
        }

        // Update numbers grid
        function updateNumbersGrid() {
            const cycle = getCurrentCycle();
            const grid = document.getElementById('numbersGrid');
            grid.innerHTML = '';
            
            cycle.numbers.forEach(number => {
                const card = document.createElement('div');
                card.className = 'number-card';
                
                const numberDiv = document.createElement('div');
                numberDiv.className = 'number';
                numberDiv.textContent = number.value;
                card.appendChild(numberDiv);
                
                if (number.used && number.dateUsed) {
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'date';
                    dateDiv.textContent = formatDateShort(number.dateUsed);
                    card.appendChild(dateDiv);
                }
                
                if (number.used) {
                    card.classList.add('used');
                    if (number.value === cycle.lastDrawn) {
                        card.classList.add('just-drawn');
                    }
                    // Add click handler for editing
                    card.addEventListener('click', () => editNumber(number.value));
                } else {
                    // Add class and click handler for manual marking
                    card.classList.add('available');
                    card.addEventListener('click', () => manualMarkNumber(number.value));
                }
                
                grid.appendChild(card);
            });
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Format date short for cards
        function formatDateShort(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Create chart
        function createChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cumulative Savings (€)',
                        data: [],
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Savings Progress Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value;
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
            
            updateChart();
        }

        // Update chart
        function updateChart() {
            if (!chart) return;
            
            const cycle = getCurrentCycle();
            const labels = [];
            const data = [];
            
            // Add starting balance as day 0
            if (cycle.startingBalance > 0) {
                labels.push('Start');
                data.push(cycle.startingBalance);
            }
            
            // Add daily progress
            cycle.dailyProgress.forEach(day => {
                labels.push(formatDateShort(day.date));
                data.push(cycle.startingBalance + day.cumulative);
            });
            
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const dataModal = document.getElementById('dataModal');
            const editModal = document.getElementById('editModal');
            const manualModal = document.getElementById('manualModal');
            
            if (event.target === dataModal) {
                closeDataModal();
            }
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === manualModal) {
                closeManualModal();
            }
        });

        // Initialize app when page loads
        window.addEventListener('load', loadData);
    </script>
</body>
</html>